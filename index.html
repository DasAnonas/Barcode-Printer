<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Печать кодов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
	
	<link rel="stylesheet" type="text/css" href="print.min.css">
  </head>
	<body style="min-height:100vh">
    	<div class="h-100 container-fluid text-center align-items-center justify-content-center">
			<div class="row justify-content-center">
				<div class="col-xl-6 col-lg-8">
					<div class="row align-items-center justify-content-center mb-4 mt-2">
						<div class="col-6">
							<h2>Печать этикеток</h2>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-xl-10 col-xxl-7 col-sm-12 mb-4">
							<h3 class="col-form-label" style="text-align: start">Номер пробы</h3>
						</div>
					</div>
					<div class="row justify-content-center mb-2">
						<div class="col-xl-10 col-xxl-7 col-sm-12" id="inputs-wrap">
							<div class="row mb-2" id="probe-wrap-1">
								<div class="col-8">
									<input type="text" id="number-1" class="form-control form-input">
								</div>
								<div class="col-1 my-auto" style="cursor: pointer;">
									<img src="print.svg" onclick="printLine(1)" style="height: 24px">
								</div>
								<div class="col-1 my-auto" style="cursor: pointer">
									<img src="close.svg" onclick="deleteLine(1)">
								</div>
								<div id="error-label-1" class="text-danger error-label p-2" style="text-align: start;"></div>
							</div>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-xl-10 col-xxl-7 col-4 col-sm-12 mb-4" style="text-align: start">
							<button onclick="addCode()" id="addCode" class="btn btn-primary mb-3">Добавить код</button>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-md-7 col-4 col-sm-12 mb-2" style="text-align: center">
							<button onclick="printAll()" id="printAll" class="btn btn-primary mb-3">Печать всех кодов</button>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-md-7 col-4 col-sm-12 mb-2" style="text-align: center">
							<button onclick="clearAll()" id="clearAll" class="btn btn-danger mb-3">Очистить</button>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-md-7 col-4 col-sm-12 mb-2" style="text-align: center">
							<button data-bs-toggle="modal" data-bs-target="#settingsModal" id="printAll" class="btn btn-primary mb-3">Настройки</button>
						</div>
					</div>

			</div>
			<div class="row align-items-center justify-content-center mb-3" style="position: absolute; left:-20000px;">
				<div class="col-12" style="text-align: center;" id="codes-wrap">
				</div>
			</div>
		</div>
	</body>
	<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
		  <div class="modal-content">
			<div class="modal-header">
			  <h1 class="modal-title fs-5" id="exampleModalLabel">Настройки</h1>
			  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="row justify-content-center">
					<div class="col-md-7 col-4 col-sm-12 mb-4" style="text-align: center">
						<select class="form-select" id="codeType" aria-label="Default select example">
							<option value="pdf417">PDF417</option>
							<option value="code128">Barcode</option>
						  </select>
					</div>
				</div>
				<div class="row justify-content-center">
					<div class="col-md-7 col-4 col-sm-12 mb-4" style="text-align: center">
						<input type="number" id="height" placeholder="Высота" class="form-control">
					</div>
				</div>
				<div class="row justify-content-center">
					<div class="col-md-7 col-4 col-sm-12 mb-4" style="text-align: center">
						<input type="number" id="scale" placeholder="Масштаб" class="form-control">
					</div>
				</div>
				<div class="row justify-content-center">
					<div class="col-md-7 col-4 col-sm-12 mb-4" style="text-align: center">
						<input type="number" id="fontSize" placeholder="Размер текста" class="form-control">
					</div>
				</div>
				<div class="row justify-content-center">
					<div class="col-md-7 col-4 col-sm-12 mb-4" style="text-align: center">
						<div class="row mb-2" id="probe-wrap-test">
							<div class="col-8">
								<input type="text" id="testText" class="form-control">
							</div>
							<div class="col-2 my-auto" style="cursor: pointer">
								<img src="refresh.svg" onclick="createTestCode()" style="height: 24px">
							</div>
							<div class="col-2 my-auto" style="cursor: pointer;">
								<img src="print.svg" onclick="printTestCode()" style="height: 24px">
							</div>
						</div>
					</div>
				</div>
				<div class="row justify-content-center">
					<div class="col-md-7 col-4 col-sm-12 mb-4" style="text-align: center">
						<div id="code-wrap-test" style="text-align: center; display: inline-block;">
							<canvas id="code-test" ></canvas>
							<h4 id="code-text-test" style="margin: 0;"></h4>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
			  <button type="button" onclick="setSettingsInputs()" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
			  <button type="button" onclick="saveSettings()" class="btn btn-primary" data-bs-dismiss="modal">Сохранить</button>
			</div>
		  </div>
		</div>
	  </div>
</html>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js" integrity="sha512-01CJ9/g7e8cUmY0DFTMcUw/ikS799FHiOA0eyHsUWfOetgbx/t6oV4otQ5zXKQyIrQGTHSmRVPIgrgLcZi/WMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="print.min.js"></script>
	<script src="bwip-js-min.js"></script>
	<script>
		let count = 1;
		let scale;
		let height;
		let codeType;
		let fontSize;
		readSettings();
		setSettingsInputs();
		
		function readSettings() {
			scale = localStorage.getItem('codeScale') || 3;
			height = localStorage.getItem('codeHeight') || 30;
			codeType = localStorage.getItem('codeType') || 'pdf417';
			fontSize = localStorage.getItem('codeFontSize') || 24;
		}

		function setSettingsInputs() {
			document.getElementById('scale').value = scale;
			document.getElementById('height').value = height;
			document.getElementById('codeType').value = codeType;
			document.getElementById('fontSize').value = fontSize;
		}

		function saveSettings() {
			localStorage.setItem('codeScale', document.getElementById('scale').value);
			localStorage.setItem('codeHeight', document.getElementById('height').value);
			localStorage.setItem('codeType', document.getElementById('codeType').value);
			localStorage.setItem('codeFontSize', document.getElementById('fontSize').value);
			readSettings();
		}

		function addCode() {
			count ++;
			document.getElementById('inputs-wrap').insertAdjacentHTML('beforeend', `
			<div class="row mb-2 probe-wrap" id="probe-wrap-${count}">
				<div class="col-8">
					<input type="text" id="number-${count}" class="form-control form-input">
				</div>
					<div class="col-1 my-auto" style="cursor: pointer;">
						<img src="print.svg" onclick="printLine(${count})" style="height: 24px">
					</div>
					<div class="col-1 my-auto" style="cursor: pointer">
						<img src="close.svg" onclick="deleteLine(${count})">
					</div>
					<div id="error-label-${count}" class="text-danger error-label p-2" style="text-align: start;"></div>
			</div>
			`);
		}

		function deleteLine(id) {
			document.getElementById('probe-wrap-' + id).remove();
			count --;
		}

		async function printLine(id) {
			const codesWrap = document.getElementById('codes-wrap');
			const inputText = document.getElementById('number-' + id).value;
			
			if (validate(id)) {
				codesWrap.insertAdjacentHTML('beforeend', `
					<div id="code-wrap" style="text-align: center; display: inline-block;">
						<canvas id="code" ></canvas>
						<h4 id="code-text" style="margin: 0; font-size:${fontSize}px">${inputText}</h4>
					</div>
				`);
				const pdfCode = await bwipjs.toCanvas('code', {
        			bcid:        codeType,       // Barcode type
        			text:        inputText,    // Text to encode
        			scale:       scale,               // 3x scaling factor
        			height:      height,              // Bar height, in millimeters
    			});
				const pdf = document.getElementById("code-wrap");
				const img = await domtoimage.toPng(pdf);
				printJS({printable: img, type: 'image'});
				codesWrap.innerHTML = '';
			}
		}


		async function printAll() {
			const codesWrap = document.getElementById('codes-wrap');
			const inputs = document.getElementsByClassName('form-input');
			const printables = [];
			let validated = true;
			for (let i = 0; i<inputs.length; i++) {
				validated = validate(i+1) && validated;
			}
			if (validated && inputs.length>0) {
				for (let i = 0; i<inputs.length; i++) {
					const inputText = document.getElementById('number-' + (i+1)).value;
					codesWrap.insertAdjacentHTML('beforeend', `
					<div id="code-wrap-${i + 1}" style="text-align: center; display: inline-block;">
						<canvas id="code-${i + 1}" ></canvas>
						<h4 id="code-text-${i + 1}" style="margin: 0; font-size:${fontSize}px">${inputText}</h4>
					</div>
				`);
				const pdfCode = await bwipjs.toCanvas('code-' + (i+1), {
        			bcid:        codeType,       // Barcode type
        			text:        inputText,    // Text to encode
        			scale:       scale,               // 3x scaling factor
        			height:      height,              // Bar height, in millimeters
    			});
				const pdf = document.getElementById("code-wrap-" + (i+1));
				const img = await domtoimage.toPng(pdf);
				printables.push(img);
				}	
				printJS({printable: printables, type: 'image', imageStyle: 'width:100%;margin-bottom:10px;'});
				codesWrap.innerHTML = '';
			}
		}

		function clearAll() {
			const inputs = document.getElementsByClassName('form-input');
			const labels = document.getElementsByClassName('error-label');
			for (let i = 2; i<= count; i++) {
				document.getElementById('probe-wrap-' + i).remove();
			}
			document.getElementById('number-1').value = '';
			document.getElementById('error-label-1').innerHTML = '';
			count = 1;
		}

		function validate(id) {
			const inputText = document.getElementById('number-' + id).value;
			const errorLabel = document.getElementById('error-label-' + id);
			console.log('validating ' + id)
			if (!inputText || inputText.length === 0) {
				errorLabel.innerHTML = 'Поле не должно быть пустым';
				return false;
			}
			if (!/[a-zA-Z0-9\-]{1,}/.test(inputText)) {
				errorLabel.innerHTML = 'Ошибка, код может включать в себя только цифры, "-" и латиницу';
				return false;
			}
			errorLabel.innerHTML = '';
			return true;
		}

		async function createTestCode() {
			const text = document.getElementById('testText').value;
			const testScale = document.getElementById('scale').value;
			const testHeight = document.getElementById('height').value;
			const testCodeType = document.getElementById('codeType').value;
			document.getElementById('code-text-test').innerHTML = text;
			document.getElementById('code-text-test').style.fontSize = document.getElementById('fontSize').value + 'px';
			const pdfCode = await bwipjs.toCanvas('code-test', {
        			bcid:        testCodeType,       // Barcode type
        			text:        text,    // Text to encode
        			scale:       testScale,               // 3x scaling factor
        			height:      testHeight,              // Bar height, in millimeters
    			});
		}

		async function printTestCode() {
			const pdf = document.getElementById("code-wrap-test");
			const img = await domtoimage.toPng(pdf);
			printJS({printable: img, type: 'image'});
		}

	</script>